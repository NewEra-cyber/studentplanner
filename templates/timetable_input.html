{% extends 'base.html' %}
{% block title %}Timetable Input - Beast Mode Planner{% endblock %}
{% load custom_filters %}


{% block content %}
<!-- Full-page wallpaper background -->
<div id="page-bg" aria-hidden="true"></div>

<!-- SVG Hex overlay at the top -->
<svg id="hex-overlay" viewBox="0 0 1600 240" preserveAspectRatio="none" aria-hidden="true">
  <defs>
    <pattern id="hex" width="80" height="69.28" patternUnits="userSpaceOnUse">
      <path d="M40 0 L80 20 L80 49.28 L40 69.28 L0 49.28 L0 20 Z" fill="none" stroke="rgba(34,197,94,0.08)" stroke-width="1"/>
    </pattern>
    <linearGradient id="hex-fade" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0" stop-color="rgba(6,6,7,0.12)"/>
      <stop offset="1" stop-color="rgba(6,6,7,0)"/>
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#hex)"/>
  <rect width="100%" height="100%" fill="url(#hex-fade)"/>
</svg>

<div class="container mx-auto px-4 py-6 relative z-10">
    <!-- HEADER -->
    <div class="rounded-xl overflow-hidden relative border border-gray-800 bg-black/60 p-6 mb-6 shadow-xl backdrop-blur-sm">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-mono font-bold text-green-300">
                    <i class="fas fa-calendar-alt mr-3 text-green-400"></i>
                    Manual Timetable Input
                </h1>
                <p class="text-gray-400 mt-2">Input your school timetable (Monday-Friday) and generate optimized study schedule</p>
            </div>
            <div class="flex gap-3">
                <button onclick="generateSchedule()" class="bg-green-600 hover:bg-green-700 text-black font-semibold px-4 py-2 rounded-md transition-colors">
                    <i class="fas fa-magic mr-2"></i> Generate Schedule
                </button>
                <a href="{% url 'dashboard' %}" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-md border border-gray-700 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- INPUT FORM -->
        <div class="lg:col-span-1">
            <div class="bg-black/60 border border-gray-800 rounded-lg p-6 shadow-lg backdrop-blur-sm">
                <h3 class="text-lg font-mono text-green-300 mb-4">
                    <i class="fas fa-plus-circle mr-2 text-green-400"></i> Add Class
                </h3>
                
                <form method="POST" class="space-y-4" id="activityForm">
                    {% csrf_token %}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Activity Type</label>
                        <select name="activity_type" id="activityType" class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                            {% for value, display in activity_types %}
                            <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Day</label>
                        <select name="day" required class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                            <option value="">Select Day</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Start Time</label>
                            <input type="time" name="start_time" required 
                                   class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">End Time</label>
                            <input type="time" name="end_time" required 
                                   class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                        </div>
                    </div>
                    
                    <!-- Academic-only fields (shown only for lecture, lab, review) -->
                    <div id="academicFields" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Unit Code</label>
                            <input type="text" name="unit_code" id="unitCode" placeholder="e.g., ICS 2203"
                                   class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Unit Name</label>
                            <input type="text" name="unit_name" id="unitName" placeholder="e.g., Web Application Development 1"
                                   class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Venue</label>
                            <input type="text" name="venue" id="venue" placeholder="e.g., CLB 101"
                                   class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                        </div>
                    </div>
                    
                    <!-- Personal activity name field (shown for non-academic activities) -->
                    <div id="personalFields" class="space-y-4" style="display: none;">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Activity Name</label>
                            <input type="text" name="activity_name" id="activityName" placeholder="e.g., Morning Workout"
                                   class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Location (Optional)</label>
                            <input type="text" name="location" id="location" placeholder="e.g., Gym, Home"
                                   class="w-full bg-gray-900 border border-gray-700 rounded-md px-3 py-2 text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 transition-colors">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-black font-semibold py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-save mr-2"></i> Add to Timetable
                    </button>
                </form>
                
                <div class="mt-6 p-4 bg-yellow-900/20 border border-yellow-700 rounded-md">
                    <h4 class="text-sm font-semibold text-yellow-300 mb-2">
                        <i class="fas fa-lightbulb mr-2"></i> Pro Tip
                    </h4>
                    <p class="text-xs text-yellow-200">
                        After adding all classes, click "Generate Schedule" to automatically create study blocks around your classes!
                    </p>
                </div>
            </div>
        </div>

        <!-- TIMETABLE DISPLAY -->
        <div class="lg:col-span-2">
            <div class="bg-black/60 border border-gray-800 rounded-lg p-6 shadow-lg backdrop-blur-sm">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-mono text-green-300">
                        <i class="fas fa-table mr-2 text-green-400"></i> Your Timetable
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="clearTimetable()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm transition-colors">
                            <i class="fas fa-trash mr-1"></i> Clear All
                        </button>
                    </div>
                </div>

                {% if timetable_by_day %}
                <div class="space-y-6">
                    {% for day in days %}
                    {% if timetable_by_day|get_item:day %}
                    <div class="border border-gray-700 rounded-lg overflow-hidden">
                        <div class="bg-gray-900 px-4 py-3 border-b border-gray-700">
                            <h4 class="font-semibold text-green-300">{{ day }}</h4>
                        </div>
                        <div class="divide-y divide-gray-800">
                            {% for entry in timetable_by_day|get_item:day %}
                            <div class="p-4 hover:bg-gray-900/50 transition-colors flex justify-between items-center">
                                <div class="flex items-center space-x-4">
                                    <div class="w-24 text-left">
                                        <span class="font-mono text-sm text-gray-300">{{ entry.start_time|time:"H:i" }}</span>
                                        <span class="block text-xs text-gray-500">{{ entry.end_time|time:"H:i" }}</span>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-100">{{ entry.unit_code }}</p>
                                        <p class="text-sm text-gray-400">{{ entry.unit_name }}</p>
                                        <p class="text-xs text-gray-500 mt-1">{{ entry.venue }}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-blue-900/30 text-blue-300 border border-blue-700">
                                        {{ entry.get_activity_type_display }}
                                    </span>
                                    <form method="POST" action="{% url 'delete_timetable_entry' entry.id %}" class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="text-red-400 hover:text-red-300 transition-colors" onclick="return confirm('Delete this entry?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-400">
                    <i class="fas fa-calendar-plus text-4xl mb-4 text-green-400"></i>
                    <p class="text-lg font-semibold">No timetable entries yet</p>
                    <p class="text-sm mt-2">Add your classes using the form to get started!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Define academic activity types
const ACADEMIC_TYPES = ['lecture', 'lab', 'review'];

// Function to toggle field visibility based on activity type
function toggleFields() {
    const activityType = document.getElementById('activityType').value;
    const academicFields = document.getElementById('academicFields');
    const personalFields = document.getElementById('personalFields');
    const unitCode = document.getElementById('unitCode');
    const unitName = document.getElementById('unitName');
    const activityName = document.getElementById('activityName');
    
    if (ACADEMIC_TYPES.includes(activityType)) {
        // Show academic fields, hide personal fields
        academicFields.style.display = 'block';
        personalFields.style.display = 'none';
        
        // Make academic fields required
        unitCode.required = true;
        unitName.required = true;
        activityName.required = false;
    } else {
        // Show personal fields, hide academic fields
        academicFields.style.display = 'none';
        personalFields.style.display = 'block';
        
        // Make personal fields required
        unitCode.required = false;
        unitName.required = false;
        activityName.required = true;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleFields();
    
    // Add event listener to activity type selector
    document.getElementById('activityType').addEventListener('change', toggleFields);
});

async function generateSchedule() {
    try {
        const response = await fetch('{% url "generate_schedule_from_timetable" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ ' + data.message);
            // Redirect to dashboard to see the generated schedule
            setTimeout(() => {
                window.location.href = '{% url "dashboard" %}';
            }, 1500);
        } else {
            alert('❌ ' + data.error);
        }
    } catch (error) {
        alert('❌ Error generating schedule: ' + error.message);
    }
}

async function clearTimetable() {
    if (!confirm('Are you sure you want to clear ALL timetable entries? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "clear_timetable" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ ' + data.error);
        }
    } catch (error) {
        alert('❌ Error clearing timetable: ' + error.message);
    }
}
</script>

<style>
/* -------------------------
   Page background + hex overlay
   ------------------------- */
#page-bg {
  position: fixed;
  inset: 0;
  z-index: -2;
  background-image: url('https://www.zoomgroup.com/public/storage/images/courses/Linux-Administration-slider.webp');
  background-size: cover;
  background-position: center center;
  background-attachment: fixed;
  filter: brightness(0.36) saturate(0.9);
}

/* hex overlay top styling (placed above bg, behind content) */
#hex-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 220px;
  z-index: -1;
  pointer-events: none;
}

/* main theme accents */
:root{
  --neon-green: #10b981;
  --neon-blue: #60a5fa;
  --panel-bg: rgba(6,6,7,0.6);
}

.nav-btn {
    transition: all .18s ease;
}
.nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(16,185,129,0.06);
}

/* responsiveness minor */
@media (max-width: 768px) {
  #hex-overlay { height: 160px; }
}
</style>
{% endblock %}